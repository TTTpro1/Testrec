name: Subfinder + FFUF + Telegram

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target domain (example.com)"
        required: true
        type: string
      wordlist_url:
        description: "URL to directory wordlist"
        required: true
        type: string

  schedule:
    - cron: "0 */5 * * *" # every 5 hours (uses default target below)

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Set target (manual or scheduled)
        run: |
          if [ -z "${{ github.event.inputs.target }}" ]; then
            echo "TARGET=${{ secrets.DEFAULT_TARGET }}" >> $GITHUB_ENV
            echo "WORDLIST_URL=${{ secrets.DEFAULT_WORDLIST_URL }}" >> $GITHUB_ENV
          else
            echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
            echo "WORDLIST_URL=${{ github.event.inputs.wordlist_url }}" >> $GITHUB_ENV
          fi

      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y ffuf
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run subfinder
        run: |
          subfinder -d $TARGET -silent > subdomains.txt

      - name: Download wordlist
        run: |
          curl -L $WORDLIST_URL -o wordlist.txt

      - name: Run ffuf directory fuzzing
        run: |
          > ffuf_results.txt
          while read sub; do
            ffuf -u https://$sub/FUZZ \
              -w wordlist.txt \
              -mc 200,204,301,302,403 \
              -of csv \
              -o temp.csv || true

            if [ -s temp.csv ]; then
              echo "Results for $sub" >> ffuf_results.txt
              tail -n +2 temp.csv >> ffuf_results.txt
              echo "" >> ffuf_results.txt
            fi
          done < subdomains.txt

      - name: Send results to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -s ffuf_results.txt ]; then
            MESSAGE=$(sed ':a;N;$!ba;s/\n/%0A/g' ffuf_results.txt | cut -c1-3900)
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="ðŸ” Scan Results for $TARGET:%0A${MESSAGE}"
          else
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d chat_id="${CHAT_ID}" \
              -d text="â„¹ï¸ Scan completed for $TARGET â€” no directories found."
          fi
